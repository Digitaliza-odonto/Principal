<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento pela triagem</title>
    <!-- jQuery library -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- jQuery UI CSS -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

    <!-- jQuery UI JavaScript -->
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

    <script type="text/javascript" async="" defer="" src="https://stats.ufpel.edu.br/piwik.js"></script><script type="text/javascript">
        var BASE_URL = 'https://cobalto.ufpel.edu.br/';
        var WIKI = 'http://wikicobalto.ufpel.edu.br/doku.php?';
        var PATH_COOKIE = '/';
        var IMG = 'https://cobalto.ufpel.edu.br/static/_img';
        var JS = 'https://cobalto.ufpel.edu.br/static/_js';
    </script>
    <link rel="shortcut icon" href="https://cobalto.ufpel.edu.br/static/_img/favicon.ico" type="image/ico">
    <link href='https://cobalto.ufpel.edu.br/static/_css/redmond/all.css.jquery-ui.06102023101234850017.css' type='text/css' rel='stylesheet'/>
    <script type='text/javascript' src='https://cobalto.ufpel.edu.br/static/_js/all.javascript.06102023101234850017.js'></script>
    <link href="../../../stylecobalto.css" type="text/css" rel="stylesheet">
    <link href="../../../stylecobaltomodificado.css" type="text/css" rel="stylesheet">

    <!--ALERT MESSAGES-->
    <link href="../../../scripts/alert-message.css" type="text/css" rel="stylesheet">
    <script src="../../../scripts/alertMessage.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
          var okButton = document.getElementById('okButton');
      
          okButton.addEventListener('click', function() {
            window.location.reload(); // This line reloads the current page
          });
        });
      </script>
      
    <!-- HIDDEN DIV FOR ALERT MESSAGE -->
    <div id="customAlert" class="modal">
        <div class="ui-dialog ui-widget ui-widget-content ui-corner-all ui-front ui-dialog-buttons ui-draggable ui-resizable centered-modal">
        <div class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix">
            <span id="ui-id-12" class="ui-dialog-title">Atenção</span>
            <button class="ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only ui-dialog-titlebar-close" role="button">
            <span class="close ui-button-icon-primary ui-icon ui-icon-closethick" style="display: flex;  float:right; margin-right: -8px; margin-top: -8px;"></span>
            </button>
        </div>
        <p></p>
        <br>
        <div id="dialog-message-info" style="width: auto; min-height: 0px; max-height: none; height: auto;" class="ui-dialog-content ui-widget-content">
            <span class="ui-icon ui-icon-info" style="float:left; margin:12px 0 0 0;"></span>
            <p id="alertMessage"></p>
        </div>
        <p> </p><br>
        <p> </p><br>
        <p> </p><br>
        <div><button id="okButton" class="centered-button">OK</button></div>
        </div>
    </div>
    </head>
    
    <body>
    <!-- CONTEÚDO DA PÁGINA/TELA DO COBALTO COMEÇA AQUI -->
    <div id="content-center" class="ui-layout-center ui-widget-content"
    style="background: none !important; overflow: hidden !important">
    
    <div class="breadCrumb module">
    <ul>
        <li><a href="index.html"></a></li>
        <li>Gestão Saúde</li>
        <li>Triagem</li>    
        <li>Cadastros</li>
        <li>Agendamento pela triagem</li>
    </ul>
    <div style="clear: both;"></div>
    </div>
    <div style="clear: both;"></div>
    
    <div class="ui-widget-content ui-corner-all toolbar">
    <button id="voltar-pagina" class="voltar-pagina" style="float: left;">Voltar página</button>
    <button id="ajuda" class="ajuda" title="F1" style="float: right;">Ajuda</button>
    <span style="clear: both; display: block"></span>
    </div>

    </div>
    
    <!-- COLUNA DA ESQUERDA -->
    <div style="width: 40%; height: 850px; float: left; box-sizing: border-box;">
        <div id="agendarAtendimento" class="tabs" style="width: 100%; height: 20%px; float: left; box-sizing: border-box;">
            <div id="agendarAtendimento-0" class="ui-widget agendarAtendimento-0">
                <ul>
                    <li class="agendarAtendimento"><a href="#agendarAtendimento-0" accessKey="agendarAtendimento-0">Cadastrar novo agendamento</a></li>
                </ul>
            </div>

            <div style="margin: 20px;">
                <p></p>

                <form method="post" action="../../../API/agenda/agendamento-insert-remove.php" id="agendamentoForm">
                    
                    <div>
                    <p></p>
                    <br>
                    
                    <!-- Add hidden fields for 'id_agendamento' and 'agendado_por' -->
                    <input type="hidden" id="id_agendamento" name="id_agendamento"/>
                    <input type="hidden" id="agendado_por" name="agendado_por"/>

                    <script>
                        function getUrlVars() {
                            var vars = {};
                            var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
                                vars[key] = decodeURIComponent(value); // Decode URI component to handle special characters
                            });
                            return vars;
                        }
                        const urlParams = getUrlVars();
                        const alunoMatricula = urlParams.matricula; // Assuming 'matricula' is the parameter name in the URL

                        document.getElementById('agendado_por').value = alunoMatricula;
                    </script>

                    <label style="width: 200px; margin: 5px;">Paciente</label>
                    <input type="text" id="pacienteAgendamento" value="" maxlength="255" class="ui-state-default ui-corner-all mousetrap " style=" width: 50%;" placeholder="Selecione algum paciente" readonly>
                    <br>

                    <label style="width: 200px; margin: 5px;">CPF paciente</label>
                    <input type="text" name="cpf_paciente" id="cpf_paciente" maxlength="11" class="ui-state-default ui-corner-all" style="width: 20%;" placeholder="Selecione algum paciente" readonly>
                    <br>

                    <br>
                    <label style="width: 200px; margin: 5px;">Descrição do procedimento</label>
                    <input type="text" id="descricao" maxlength="" class="ui-state-default ui-corner-all mousetrap" style="width: 50%;" placeholder="Descrição do procedimento">

                    
                    <br>
                    <label style="width: 200px; margin: 5px;">Data do agendamento</label>
                    <input type="text" id="data_agendamento" maxlength="10" class="ui-state-default ui-corner-all mousetrap  datepicker" style=" width: 80px;">
                    <br>

                    <label style="width: 200px; margin: 5px;">Horário</label>
                    <select class="ui-state-default ui-corner-all" style="width: 10%; height: 20px;" id="horario_agendamento_1">
                        <option value="HH">HH</option>
                        <option value="08">08</option>
                        <option value="09">09</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                    </select>
                    <select class="ui-state-default ui-corner-all" style="width: 10%; height: 20px;" id="horario_agendamento_2">
                        <option value="MM">MM</option>
                        <option value="00">00</option>
                        <option value="15">15</option>
                        <option value="30">30</option>
                        <option value="45">45</option>
                    </select>
                    <br>

                    <label style="width: 200px; margin: 5px;">Local que será realizado o atendimento</label>
                    <select class="ui-state-default ui-corner-all" style="width: 20%; height: 20px;" name="local" id="local">
                        <option value="Escolher">Escolher</option>
                        <option value="Clínica Sul - 1º Andar">Clínica Sul -1º Andar</option>
                        <option value="Clínica Oeste">Clínica Oeste</option>
                        <option value="Clínica Sul - 2º Andar">Clínica Sul - 2º Andar</option>
                        <option value="Clínica Norte - 2º Andar">Clínica Norte - 2º Andar</option>
                        <option value="Bloco - 3º Andar">Bloco - 3º Andar</option>
                        <option value="Ambulatório - 3º Andar">Ambulatório - 3º Andar</option>
                        <option value="Consultório individualizado - 3º Andar">Consultório individualizado - 3º Andar</option>
                        <option value="Clínica 4º Andar">Clínica 4º Andar</option>
                        <option value="Radiologia">Clínica de Radiologia</option>
                    </select>
                    <p></p>
                    <br>
                
                    <label style="width: 200px; margin: 5px;">Disciplina</label>
                    <input type="text" id="atividade_curricular" value="" maxlength="10" class="ui-state-default ui-corner-all mousetrap " style=" width: 50%;" placeholder="Selecione algum paciente" readonly>
                    <br>
                    <p></p>

                    <div style="margin: 20px; margin-left: 10%;">
                        <button type="submit" id="btnAdicionar" onclick="agendarAtendimento()" class="button">Cadastrar agendamento</button>
                        <button name="deleteButton" id="deleteButton" onclick="deleteAgendamento()" value="deleteButton" class="button">Excluir agendamento</button>
                        <!-- <button name="btnCancelar" onClick="limparCampos()" id="btnCancelar" value="Cancelar" class="button">Apagar campos</button> -->
                    </div>
                </form>

                <br>
            </div>
        </div>
            
        <!-- COLUNA DA ESQUERDA / MEUS PACIENTES-->
        <div id="MeusPacientes" class="tabs" style="width: 100%; height: 475px; float: left; box-sizing: border-box;">
            <div id="MeusPacientes-0" class="ui-widget MeusPacientes-0">
                <ul>
                    <li class="MeusPacientes"><a href="#MeusPacientes-0" accessKey="MeusPacientes-0">Meus pacientes</a></li>
                </ul>
            </div>

            <div style="margin: 10px; width: 97%;">
                <table id="gridPaciente"></table>
                <div id="gridPacientePager" style="margin-bottom: 5px;"></div>  
                </div>
            </div>
            </div>
        </div>
    
        <script>
            var gridId = 'gridPaciente';
            var headerColumns = ["ID", "Nome", "CPF", "Telefone", "Telefone 2", "Disciplina"];
            var columnNames = ["id", "paciente_nome", "cpf", "Tel", "Tel2", "atividade"];
            var columnWidths = [0, 50, 50, 50, 50, 100];
            var rowHeight = 30; // Set the height of each row in pixels
    
            $(document).ready(function () {
            $('#' + gridId).jqGrid({
                "sortname": columnNames[1],
                "autoload": false,
                "autowidth": true,
                "pager": "#" + gridId + "Pager",
                "rowNum": 25,
                "toppager": false,
                "caption": "Lista dos meus pacientes",
                "height": "auto",
                "jsonReader": { "repeatitems": false, "id": 0 },
                "colNames": headerColumns,
                "colModel": [
                    { "sortable": true, "hidden": true, "name": columnNames[0], "index": columnNames[0], "width": columnWidths[0], "align": "right" },
                    { "sortable": true, "name": columnNames[1], "index": columnNames[1], "width": columnWidths[1], "align": "left" },
                    { "sortable": true, "name": columnNames[2], "index": columnNames[2], "width": columnWidths[2], "align": "center" },
                    { "sortable": true, "name": columnNames[3], "index": columnNames[3], "width": columnWidths[3], "align": "center" },
                    { "sortable": true, "name": columnNames[4], "index": columnNames[4], "width": columnWidths[4], "align": "center" },
                    { "sortable": true, "name": columnNames[5], "index": columnNames[5], "width": columnWidths[5], "align": "center" }
                ],
                "rowHeight": rowHeight
            });
    
            $('#' + gridId).setGridParam({ datatype: 'json' });
            $('#' + gridId).setGridParam({ autoload: true });
    
            function gridResize() {
                $('#' + gridId).setGridWidth($('#gbox_' + gridId).width());
            }
    
            $(window).bind('resize', gridResize);
            $('#tabFiltroCurso').bind('tabsshow', gridResize);
            });
        </script>
    
            <script src="/API/API.js"></script>
    
            <script>
                $(document).ready(function () {
                    // Função para obter parâmetros da URL
                    function getUrlVars() {
                        var vars = {};
                        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
                            vars[key] = decodeURIComponent(value); // Decode URI component to handle special characters
                        });
                        return vars;
                    }

                    const urlParams = getUrlVars();
                    const alunoMatricula = urlParams.matricula; // Assuming 'matricula' is the parameter name in the URL

                    if (alunoMatricula) {
                        api.alunos.pacientes({ Matricula: alunoMatricula })
                            .then((data) => {
                                const vinculos = data.vinculos;
                                const pacienteInfoList = data.pacienteInfoList;

                                // Loop through each vinculo and corresponding pacienteInfo
                                vinculos.forEach((vinculo, index) => {
                                    const pacienteInfo = pacienteInfoList[index][0]; // Assuming that there is only one pacienteInfo for each vinculo
                                    const atividadeInfo = pacienteInfoList[index].TurmaInfo[0].atividade;

                                    adicionarNovaLinha(
                                        pacienteInfo.Nome,
                                        pacienteInfo.CPF,
                                        pacienteInfo.Tel,
                                        pacienteInfo.Tel2,
                                        atividadeInfo
                                    );
                                });
                            })
                            .catch((error) => {
                                console.error('Erro ao consultar pacientes:', error);
                            });
                    } else {
                        console.error('Matrícula do aluno não encontrada na URL.');
                    }
                });

            
                function adicionarNovaLinha(nome, cpf, Tel, Tel2, atividade) {
                    const tbody = document.querySelector('.ui-jqgrid-btable');

                    const novaLinha = document.createElement('tr');

                    novaLinha.setAttribute('data-nome', nome);
                    novaLinha.setAttribute('data-cpf', cpf);
                    novaLinha.setAttribute('data-telefone', Tel);
                    novaLinha.setAttribute('data-telefone2', Tel2);
                    novaLinha.setAttribute('data-atividade', atividade);

                    novaLinha.innerHTML = `
                        <td style="display: none;">ID</td>
                        <td class="ui-state-default ui-th-column ui-th-ltr">${nome}</td>
                        <td class="ui-state-default ui-th-column ui-th-ltr">${cpf}</td>
                        <td class="ui-state-default ui-th-column ui-th-ltr">${Tel}</td>
                        <td class="ui-state-default ui-th-column ui-th-ltr">${Tel2}</td>
                        <td class="ui-state-default ui-th-column ui-th-ltr">${atividade}</td>
                    `;

                    tbody.appendChild(novaLinha);

                    // Add click event listener to the new row
                    novaLinha.addEventListener('click', function () {
                        // Populate input fields with data from the clicked row
                        document.getElementById('pacienteAgendamento').value = this.getAttribute('data-nome');
                        document.getElementById('cpf_paciente').value = this.getAttribute('data-cpf');
                        document.getElementById('atividade_curricular').value = this.getAttribute('data-atividade');
                    });
                }
            
            </script>
            
            </div>
        </div>
    </div>


    <!-- COLUNA DA DIREITA -->
    <div id="agendaClinicas" class="tabs" class="tabs" style="width: 60%; height: 850px; float: left; box-sizing: border-box;">
        <div id="agendaClinicas-0" class="ui-widget agendaClinicas-0">
            <ul>
                <li class="agendaClinicas"><a href="#agendaClinicas-0" accessKey="agendaClinicas-0">Minha agenda</a></li>
            </ul>
        </div>

        <div style="margin: 20px;">
            <p></p>

                        <br>
            <label style="width: 200px; ;margin: 5px;">Filtrar por data</label>
            <input type="text" name="filtroDataAgendamento" id="filtroDataAgendamento" maxlength="10" class="ui-state-default ui-corner-all mousetrap  datepicker" style=" width: 80px;">
            
            <br>

            <label style="width: 200px; margin: 5px;">Filtrar por turno</label>
            <select class="ui-state-default ui-corner-all" style="width: 200px; height: 20px;" id="filtroTurnoAgendamento">
                <option value="Todos">Todos</option>
                <option value="Manhã">Manhã</option>
                <option value="Tarde">Tarde</option>
                <option value="Noite">Noite</option>
            </select>
            <br>

            <label style="width: 195px; margin: 5px;">Filtrar tabela pelo Local o atendimento</label>
            <select class="ui-state-default ui-corner-all" style="width: 200px; height: 20px; margin: 5px;" id="filtroLocalAgendamento">
                <option value="Todos">Todos</option>
                <option value="Clínica Sul - 1º Andar">Clínica Sul -1º Andar</option>
                <option value="Clínica Oeste">Clínica Oeste</option>
                <option value="Clínica Sul - 2º Andar">Clínica Sul - 2º Andar</option>
                <option value="Clínica Norte - 2º Andar">Clínica Norte - 2º Andar</option>
                <option value="Bloco - 3º Andar">Bloco - 3º Andar</option>
                <option value="Ambulatório - 3º Andar">Ambulatório - 3º Andar</option>
                <option value="Consultório individualizado - 3º Andar">Consultório individualizado - 3º Andar</option>
                <option value="Clínica 4º Andar">Clínica 4º Andar</option>
                <option value="Radiologia">Clínica de Radiologia</option>
            </select>
            <br>

            <label style="width: 195px; margin: 5px;">Filtrar tabela pelo componente curricular (disciplina/estágio)</label>
            <select class="ui-state-default ui-corner-all" style="width: 200px; height: 20px; margin: 5px;" id="filtroDisciplina">
                <option value="Todos">Todos</option>
                <option value="ESTÁGIO EM PRONTO ATENDIMENTO (EPA)">ESTÁGIO EM PRONTO ATENDIMENTO (EPA)</option>
                <option value="ODONTOPEDIATRIA">ODONTOPEDIATRIA</option>
                <option value="PERIODONTIA CLÍNICA">PERIODONTIA CLÍNICA</option>
                <option value="PRÓTESE DENTÁRIA PARCIAL III">PRÓTESE DENTÁRIA PARCIAL III</option>
                <option value="CIRURGIA BUCO-MAXILAR III">CIRURGIA BUCO-MAXILAR III</option>
                <option value="RADIOLOGIA E IMAGINOLOGIA">RADIOLOGIA E IMAGINOLOGIA</option>
            </select>
            <p></p>
            
            <label style="width: 195px; margin: 5px;">Filtrar por status do agendamento</label>
            <select class="ui-state-default ui-corner-all" style="width: 200px; height: 20px; margin: 5px;" id="filtroStatus">
                <option value="Todos">Todos</option>
                <option value="No local">No local</option>
                <option value="Agendado">Agendado</option>
                <option value="Atendido">Atendido</option>
            </select>
            <p></p>

            
            <hr class="ui-state-default">
            <div style="margin: 5px;"></div>
            <button id="clearFilters" style="margin: 10px;">Limpar filtros</button>
                    
            
                <hr class="ui-state-default">
            
                <div style="margin-left: 10px; margin-top: 30px;  width: 90%;">
                    <table id="gridAgendados"></table>
                    <div id="gridAgendadosPager" style="margin-bottom: 5px;"></div>
                </div>
            </div>

            <script>
                var gridAgendadosId = 'gridAgendados';
                var gridAgendadosPagerId = 'gridAgendadosPager';
                var historicoHeaderColumns = ["ID", "Selec.", "Data", "Nome", "CPF", "Local", "Horário", "Atividade", "Descrição", "Status"];
                var historicoColumnNames = ["id", "selecionado", "data", "nome", "cpf_paciente", "local", "horario", "atividade", "descricao", "status"];
                var historicoColumnWidths = [0, 40, 60, 130, 80, 130, 60, 175, 175, 100];
                var historicoRowHeight = 300; // Set the height of each row in pixels
            
                $(document).ready(function () {
                    $('#' + gridAgendadosId).jqGrid({
                        "sortname": historicoColumnNames[1],
                        "autoload": false,
                        "autowidth": false,
                        "pager": "#" + gridAgendadosPagerId,
                        "rowNum": 25,
                        "toppager": false,
                        "caption": "Histórico de atendimentos do paciente",
                        "height": "auto",
                        "jsonReader": { "repeatitems": false, "id": 0 },
                        "colNames": historicoHeaderColumns,
                        "colModel": [
                            { "sortable": true, "hidden": true, "name": historicoColumnNames[0], "index": historicoColumnNames[0], "width": historicoColumnWidths[0], "align": "right" },
                            { "sortable": true, "name": historicoColumnNames[1], "index": historicoColumnNames[1], "width": historicoColumnWidths[1], "align": "center" },
                            { "sortable": true, "name": historicoColumnNames[2], "index": historicoColumnNames[2], "width": historicoColumnWidths[2], "align": "center" },
                            { "sortable": true, "name": historicoColumnNames[3], "index": historicoColumnNames[3], "width": historicoColumnWidths[3], "align": "center" },
                            { "sortable": true, "name": historicoColumnNames[4], "index": historicoColumnNames[4], "width": historicoColumnWidths[4], "align": "center" },
                            { "sortable": true, "name": historicoColumnNames[5], "index": historicoColumnNames[5], "width": historicoColumnWidths[5], "align": "center" },
                            { "sortable": true, "name": historicoColumnNames[6], "index": historicoColumnNames[6], "width": historicoColumnWidths[6], "align": "center" },
                            { "sortable": true, "name": historicoColumnNames[7], "index": historicoColumnNames[7], "width": historicoColumnWidths[7], "align": "center" },
                            { "sortable": true, "name": historicoColumnNames[8], "index": historicoColumnNames[8], "width": historicoColumnWidths[8], "align": "center" },
                            { "sortable": true, "name": historicoColumnNames[9], "index": historicoColumnNames[9], "width": historicoColumnWidths[9], "align": "center" },
                        ],
                        "rowHeight": historicoRowHeight
                    });
            
                    $('#' + gridAgendadosId).setGridParam({ datatype: 'json' });
                    $('#' + gridAgendadosId).setGridParam({ autoload: true });
            
                    function gridAgendadosResize() {
                        // Calculate the total width of columns
                        var totalWidth = historicoColumnWidths.reduce(function (acc, width) {
                            return acc + width;
                        }, 0);
                        $('#' + gridAgendadosId).setGridWidth(totalWidth);
                    }
            
                    $(window).bind('resize', gridAgendadosResize);
                    $('#tabFiltroCurso').bind('tabsshow', gridAgendadosResize);
                });
            </script>

            </div>
        </div>

        
        <script>
            $(document).ready(function () {
                var originalData; // Store the original data from the API response

                // CONVERTER DATA EM DD/MM/YYYY
                function formatDate(dateString) {
                    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                    const formattedDate = new Date(dateString).toLocaleDateString('en-GB', options);
                    return formattedDate;
                }

                // Function to populate the grid with filtered data
                function populateGridAgenda(data) {
                    var tableBody = $('#gridAgendados');
                    tableBody.empty();

                    for (var i = 0; i < data.length; i++) {
                        var item = data[i];
                        var row = '<tr>';

                    row += '<td td style="display: none;">' + item.id_agendamento + '></td>';
                    row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr" style="width: ' + historicoColumnWidths[1] + 'px;"><input type="checkbox" name="selectedId[]" value="' + item.id_agendamento + '"></td>';
                    row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr" style="width: ' + historicoColumnWidths[2] + 'px;">' + formatDate(item.data_agendamento) + '</td>';

                    // Get the 'nome' from 'pacienteInfoList'
                    var nome = "";
                    if (originalData && originalData.pacienteInfoList && originalData.pacienteInfoList[i] && originalData.pacienteInfoList[i][0]) {
                        nome = originalData.pacienteInfoList[i][0].nome || "";
                    }

                    row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr" style="width: ' + historicoColumnWidths[3] + 'px;">' + item.nome + '</td>';
                    row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr" style="width: ' + historicoColumnWidths[4] + 'px;">' + item.cpf_paciente + '</td>';
                    row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr" style="width: ' + historicoColumnWidths[5] + 'px;">' + item.local + '</td>';
                    row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr" style="width: ' + historicoColumnWidths[6] + 'px;">' + item.horario_agendamento + ':' + item.minuto_agendamento + '</td>';
                    row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr" style="width: ' + historicoColumnWidths[7] + 'px;">' + item.atividade_curricular + '</td>';
                    row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr" style="width: ' + historicoColumnWidths[8] + 'px;">' + item.descricao + '</td>';
                    row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr" style="width: ' + historicoColumnWidths[9] + 'px;">' + item.status_agendamento + '</td>';
                    row += '</tr>';
                    tableBody.append(row);
                    }
                }

                function applyFilters() {
                    var filtroDataAgendamento = $('#filtroDataAgendamento').val();
                    var filtroTurnoAgendamento = $('#filtroTurnoAgendamento').val();
                    var filtroLocalAgendamento = $('#filtroLocalAgendamento').val();
                    var filtroDisciplina = $('#filtroDisciplina').val();
                    var filtroStatus = $('#filtroStatus').val();

                    // Function to format the date as 'DD/MM/YYYY'
                    function formatDateForDisplay(dateString) {
                        const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                        const formattedDate = new Date(dateString).toLocaleDateString('en-GB', options);
                        return formattedDate;
                    }

                    // Filter data based on filter values
                    var filteredData = originalData.filter(function (item) {
                        var horario = parseInt(item.horario_agendamento);

                        var turno = '';
                        if (horario < 12) {
                            turno = 'Manhã';
                        } else if (horario >= 12 && horario < 18) {
                            turno = 'Tarde';
                        } else {
                            turno = 'Noite';
                        }

                        // Format the date for comparison
                        var formattedDataAgendamento = formatDateForDisplay(item.data_agendamento);

                        return (
                            (filtroDataAgendamento === 'Todos' || formattedDataAgendamento.includes(filtroDataAgendamento)) &&
                            (filtroTurnoAgendamento === 'Todos' || turno === filtroTurnoAgendamento) &&
                            (filtroLocalAgendamento === 'Todos' || item.local === filtroLocalAgendamento) &&
                            (filtroDisciplina === 'Todos' || item.atividade_curricular === filtroDisciplina) &&
                            (filtroStatus === 'Todos' || item.status_agendamento === filtroStatus)
                        );
                    });

                    // Populate grid with filtered data
                    populateGridAgenda(filteredData);
                }

                // Function to load data from the API and populate the gridAgenda
                function loadDataAndPopulateGrid() {

                    // Função para obter parâmetros da URL
                    function getUrlVars() {
                        var vars = {};
                        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
                            vars[key] = decodeURIComponent(value); // Decode URI component to handle special characters
                        });
                        return vars;
                    }

                    const urlParams = getUrlVars();
                    const alunoMatricula = urlParams.matricula; // Assuming 'matricula' is the parameter name in the URL

                    api.agenda.consultarAgendadosUsuario({ id: alunoMatricula }).then(function (data) {
                        // Extract relevant data from the API response
                        const vinculos = data.vinculos || [];
                        const pacienteInfoList = data.pacienteInfoList || [];

                        // Merge data from vinculos and pacienteInfoList
                        const mergedData = vinculos.map((vinculo, index) => {
                            const pacienteInfo = pacienteInfoList[index] ? pacienteInfoList[index][0] : {};
                            return { ...vinculo, ...pacienteInfo };
                        });

                        originalData = mergedData; // Store original data for filtering

                        // Initial populate grid with original data
                        populateGridAgenda(mergedData);
                    }).catch(function (error) {
                        console.log('Error fetching data');
                    });
                }

                // Initial load of table data
                loadDataAndPopulateGrid();

                function getStatusClass(status) {
                    switch (status) {
                        case 'Agendado':
                            return 'ui-state-default';
                        case 'No local':
                            return 'agendamento-ui';
                        case 'Atendido':
                            return 'atendido-ui';
                        case 'Faltou':
                            return 'faltou-ui';
                        default:
                            return '';
                    }
                }

                // Event listener for clearFilters button
                $('#clearFilters').click(function () {
                    // Clear filter inputs
                    $('#filtroDataAgendamento').val('');
                    $('#filtroTurnoAgendamento').val('Todos');
                    $('#filtroLocalAgendamento').val('Todos');
                    $('#filtroDisciplina').val('Todos');
                    $('#filtroStatus').val('Todos');

                    // Reset grid to original data
                    populateGridAgenda(originalData);
                });

                // Event listener for changes in filter inputs
                $('#filtroDataAgendamento, #filtroTurnoAgendamento, #filtroLocalAgendamento, #filtroDisciplina, #filtroStatus').change(function () {
                    // Apply filters and update the grid
                    applyFilters();
                });
            });
        </script>

        <script>
            function agendarAtendimento() {
                // Check if any required fields are empty
                const requiredFields = ['descricao', 'cpf_paciente', 'data_agendamento', 'horario_agendamento_1', 'horario_agendamento_2', 'local', 'atividade_curricular'];
                const emptyFields = requiredFields.filter(field => !$('#' + field).val().trim());

                if (emptyFields.length > 0) {
                    showCustomAlert('Por favor, preencha todos os campos obrigatórios.');
                    return; // Stop execution if any required field is empty
                }

                // Get the value of 'local'
                const localValue = $('#local').val();

                // Check if 'local' is 'Escolher'
                if (localValue === 'Escolher') {
                    showCustomAlert('Por favor, selecione um local válido.');
                    return; // Stop execution if 'local' is 'Escolher'
                }

                // Get the value of 'data_agendamento'
                const dataAgendamentoValue = $('#data_agendamento').val();

                // Split 'data_agendamento' to extract day, month, and year
                const [day, month, year] = dataAgendamentoValue.split('/');
                
                // Create a new Date object in 'YYYY-MM-DD' format
                const dataAgendamento = new Date(`${year}-${month}-${day}`);

                // Get the current date
                const currentDate = new Date();

                // Compare 'data_agendamento' with the current date
                if (dataAgendamento < currentDate) {
                    showCustomAlert('Não é permitido agendamento em datas anteriores ao dia atual.');
                    return; // Stop execution if 'data_agendamento' is lower than the current date
                }

                // Create the request data as an object
                var formData = {
                    cpf_paciente: $('#cpf_paciente').val(),
                    descricao: $('#descricao').val(),
                    data_agendamento: $('#data_agendamento').val(),
                    horario_agendamento: $('#horario_agendamento_1').val(),
                    minuto_agendamento: $('#horario_agendamento_2').val(),
                    local: $('#local').val(),
                    atividade_curricular: $('#atividade_curricular').val(),
                    agendado_por: $('#agendado_por').val()
                };

                // Perform an API request if 'data_agendamento' is valid
                api.agenda.criar(formData)
                    .then(function(response) {
                        // Check if the response contains a `message` property
                        const message = response.message || 'Agendamento realizado com sucesso.';
                        console.log(message);
                        showCustomAlert(message);
                    })
                    .catch(function(error) {
                        // Extract error message from the response or use a default error message
                        const errorMessage = error.message || 'Erro ao processar a solicitação.';
                        console.error(error);
                    });
            }
                    
            // Delete agendamento
            function deleteAgendamento() {
                const selectedIds = $("input[name='selectedId[]']:checked").map(function () {
                    // Get the value (ID) from the checkbox
                    return $(this).val(); // Assuming the value attribute holds the ID
                }).get();

                if (selectedIds.length === 0) {
                    showCustomAlert("Por favor, selecione ao menos um agendamento para excluir.");
                    return;
                }

                // Create the request data as an object
                const requestData = { selectedId: selectedIds };

                // Log the requestData for debugging
                console.log("Request Data:", requestData);

                // Perform an API request for deletion
                api.agenda.deletar(requestData)
                    .then(function (response) {
                        const message = response.message || 'Agendamento excluído com sucesso.';
                        showCustomAlert(message);
                    })
                    .catch(function (error) {
                        // Extract error message from the response or use a default error message
                        const errorMessage = error.message || 'Erro ao processar a solicitação de exclusão.';
                        console.error(error);
                    });
            }
        </script>
    </body>
</html>