<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Agenda de clínicas</title>
        <script type="text/javascript" async="" defer="" src="https://stats.ufpel.edu.br/piwik.js"></script><script type="text/javascript">
        var BASE_URL = 'https://cobalto.ufpel.edu.br/';
        var WIKI = 'http://wikicobalto.ufpel.edu.br/doku.php?';
        var PATH_COOKIE = '/';
        var IMG = 'https://cobalto.ufpel.edu.br/static/_img';
        var JS = 'https://cobalto.ufpel.edu.br/static/_js';
        </script>
        <link rel="shortcut icon" href="https://cobalto.ufpel.edu.br/static/_img/favicon.ico" type="image/ico">
        <link href='https://cobalto.ufpel.edu.br/static/_css/redmond/all.css.jquery-ui.06102023101234850017.css' type='text/css' rel='stylesheet'/>
        <script type='text/javascript' src='https://cobalto.ufpel.edu.br/static/_js/all.javascript.06102023101234850017.js'></script>
        <link href="../stylecobalto.css" type="text/css" rel="stylesheet">
        <link href="../stylecobaltomodificado.css" type="text/css" rel="stylesheet">
    </head>

    <body>
        <!-- CONTEÚDO DA PÁGINA/TELA DO COBALTO COMEÇA AQUI -->
        <div id="content-center" class="ui-layout-center ui-widget-content"
            style="background: none !important; overflow: hidden !important">
            
            <div class="breadCrumb module">
                <ul>
                    <li><a href="index.html"></a></li><li>Gestão Saúde</li>
                    <li>Consulta</li>    
                    <li>Agenda de clínicas</li>
                </ul>
                <div style="clear: both;"></div></div><div style="clear: both;"></div>
                
                <div class="ui-widget-content ui-corner-all toolbar">
                    <button id="voltar-pagina" class="voltar-pagina" style="float: left;">Voltar página</button>
                    <button id="ajuda" class="ajuda" title="F1" style="float: right;">Ajuda</button>
                    <span style="clear: both; display: block"></span>
                </div>

   
          <!-- CONTEÚDO TAB E BOTÕES DA FUNCIONALIDADE -->
            <div id="agendaClinicas" class="tabs" style="height: fit-content;">
                <div id="agendaClinicas-0" class="ui-widget agendaClinicas-0">
                    <ul>
                        <li class="agendaClinicas"><a href="#agendaClinicas-0" accessKey="agendaClinicas-0">Agenda de clínicas</a></li>
                    </ul>
                </div>

            <div style="margin: 20px;">
            <p></p>

            <br>
            <label style="width: 200px; ;margin: 5px;">Filtrar por data</label>
            <input type="text" name="filtroDataAgendamento" id="filtroDataAgendamento" maxlength="10" class="ui-state-default ui-corner-all mousetrap  datepicker" style=" width: 80px;">
            <br>
            
            <label style="width: 200px; margin: 5px;">Filtrar por turno</label>
            <select class="ui-state-default ui-corner-all" style="width: 200px; height: 20px;" id="filtroTurnoAgendamento">
                <option value="Todos">Todos</option>
                <option value="Manhã">Manhã</option>
                <option value="Tarde">Tarde</option>
                <option value="Noite">Noite</option>
            </select>
            <br>

            <label style="width: 195px; margin: 5px;">Filtrar tabela pelo Local o atendimento</label>
            <select class="ui-state-default ui-corner-all" style="width: 200px; height: 20px; margin: 5px;" id="filtroLocalAgendamento">
                <option value="Todos">Todos</option>
                <option value="Clínica Sul - 1º Andar">Clínica Sul -1º Andar</option>
                <option value="Clínica Oeste">Clínica Oeste</option>
                <option value="Clínica Sul - 2º Andar">Clínica Sul - 2º Andar</option>
                <option value="Clínica Norte - 2º Andar">Clínica Norte - 2º Andar</option>
                <option value="Bloco - 3º Andar">Bloco - 3º Andar</option>
                <option value="Ambulatório - 3º Andar">Ambulatório - 3º Andar</option>
                <option value="Consultório individualizado - 3º Andar">Consultório individualizado - 3º Andar</option>
                <option value="Clínica 4º Andar">Clínica 4º Andar</option>
                <option value="Radiologia">Clínica de Radiologia</option>
            </select>
            <br>

            <label style="width: 195px; margin: 5px;">Filtrar tabela pelo componente curricular (disciplina/estágio)</label>
            <select class="ui-state-default ui-corner-all" style="width: 200px; height: 20px; margin: 5px;" id="filtroDisciplina">
                <option value="Todos">Todos</option>
                <option value="ESTÁGIO EM PRONTO ATENDIMENTO (EPA)">ESTÁGIO EM PRONTO ATENDIMENTO (EPA)</option>
                <option value="ODONTOPEDIATRIA">ODONTOPEDIATRIA</option>
                <option value="PERIODONTIA CLÍNICA">PERIODONTIA CLÍNICA</option>
                <option value="PRÓTESE DENTÁRIA PARCIAL III">PRÓTESE DENTÁRIA PARCIAL III</option>
                <option value="CIRURGIA BUCO-MAXILAR III">CIRURGIA BUCO-MAXILAR III</option>
                <option value="RADIOLOGIA E IMAGINOLOGIA">RADIOLOGIA E IMAGINOLOGIA</option>
            </select>
            <p></p>
            
            <label style="width: 195px; margin: 5px;">Filtrar por status do agendamento</label>
            <select class="ui-state-default ui-corner-all" style="width: 200px; height: 20px; margin: 5px;" id="filtroStatus">
                <option value="Todos">Todos</option>
                <option value="No local">No local</option>
                <option value="Agendado">Agendado</option>
                <option value="Atendido">Atendido</option>
            </select>
            <p></p>

            
            <hr class="ui-state-default">
            <div style="margin: 5px;"></div>
            <button id="clearFilters" style="margin: 10px;">Limpar filtros</button>
                    
            
                <hr class="ui-state-default">
            
                <div style="margin: 30px; width: 80%;">
                    <table id="gridAgenda"></table>
                    <div id="gridAgendaPager" style="margin-bottom: 5px;"></div>  
                </div>

                <script>
                    var gridId = 'gridAgenda';
                    var headerColumns = ["ID", "Data", "Nome", "CPF", "Agendado por:", "Local", "Horário", "Atividade", "Descrição", "Status"];
                    var columnNames = ["id", "data_agendamento", "nome", "cpf_paciente", "agendado_por", "local", "horario_agendamento", "atividade_curricular", "descricao", "status_agendamento"];
                    var columnWidths = [0, 100, 100, 100, 100, 100, 100, 100, 100, 100];
                    var rowHeight = 30; // Set the height of each row in pixels
                
                    $(document).ready(function () {
                        $('#' + gridId).jqGrid({
                            "sortname": columnNames[1],
                            "autoload": false,
                            "autowidth": true,
                            "pager": "#" + gridId + "Pager",
                            "rowNum": 25,
                            "toppager": false,
                            "caption": "Agenda de clínicas",
                            "height": "auto",
                            "jsonReader": { "repeatitems": false, "id": 0 },
                            "colNames": headerColumns,
                            "colModel": [
                                { "sortable": true, "hidden": true, "name": columnNames[0], "index": columnNames[0], "width": columnWidths[0], "align": "right" },
                                { "sortable": true, "name": columnNames[1], "index": columnNames[1], "width": columnWidths[1], "align": "center" },
                                { "sortable": true, "name": columnNames[2], "index": columnNames[2], "width": columnWidths[2], "align": "center" },
                                { "sortable": true, "name": columnNames[3], "index": columnNames[3], "width": columnWidths[3], "align": "center" },
                                { "sortable": true, "name": columnNames[4], "index": columnNames[4], "width": columnWidths[4], "align": "center" },
                                { "sortable": true, "name": columnNames[5], "index": columnNames[5], "width": columnWidths[5], "align": "center" },
                                { "sortable": true, "name": columnNames[6], "index": columnNames[6], "width": columnWidths[6], "align": "center" },
                                { "sortable": true, "name": columnNames[7], "index": columnNames[7], "width": columnWidths[7], "align": "center" },
                                { "sortable": true, "name": columnNames[8], "index": columnNames[8], "width": columnWidths[8], "align": "center" },
                                { "sortable": true, "name": columnNames[9], "index": columnNames[9], "width": columnWidths[9], "align": "center" }
                            ],
                            "rowHeight": rowHeight
                        });
                
                        $('#' + gridId).setGridParam({ datatype: 'json' });
                        $('#' + gridId).setGridParam({ autoload: true });
                
                        function gridResize() {
                            $('#' + gridId).setGridWidth($('#gbox_' + gridId).width());
                        }
                
                        $(window).bind('resize', gridResize);
                        $('#tabFiltroCurso').bind('tabsshow', gridResize);
                    });
                    </script>
            </div>
        </div>

        <!-- API -->
       <script src="../API/API.js"></script>

        <script>
            $(document).ready(function () {
                var originalData; // Store the original data from the API response

                // CONVERTER DATA EM DD/MM/YYYY
                function formatDate(dateString) {
                    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                    const formattedDate = new Date(dateString).toLocaleDateString('en-GB', options);
                    return formattedDate;
                }

                // Function to populate the grid with filtered data
                function populateGridAgenda(data) {
                    var tableBody = $('#gridAgenda');
                    tableBody.empty();

                    for (var i = 0; i < data.length; i++) {
                        var item = data[i];
                        var row = '<tr>';
                        row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr">' + formatDate(item.data_agendamento) + '</td>';
                        row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr">' + item.nome_paciente + '</td>';
                        row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr">' + item.cpf_paciente + '</td>';
                        row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr">' + item.nome_usuario + '</td>';
                        row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr">' + item.local + '</td>';
                        row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr">' + item.horario_agendamento + ':' + item.minuto_agendamento + '</td>';
                        row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr">' + item.atividade_curricular + '</td>';
                        row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr">' + item.descricao + '</td>';
                        row += '<td class="' + getStatusClass(item.status_agendamento) + ' ui-th-column ui-th-ltr">' + item.status_agendamento + '</td>';
                        row += '</tr>';
                        tableBody.append(row);
                    }
                }

                function applyFilters() {
                    var filtroDataAgendamento = $('#filtroDataAgendamento').val();
                    var filtroTurnoAgendamento = $('#filtroTurnoAgendamento').val();
                    var filtroLocalAgendamento = $('#filtroLocalAgendamento').val();
                    var filtroDisciplina = $('#filtroDisciplina').val();
                    var filtroStatus = $('#filtroStatus').val();

                    // Function to format the date as 'DD/MM/YYYY'
                    function formatDateForDisplay(dateString) {
                        const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                        const formattedDate = new Date(dateString).toLocaleDateString('en-GB', options);
                        return formattedDate;
                    }

                    // Filter data based on filter values
                    var filteredData = originalData.filter(function (item) {
                        var horario = parseInt(item.horario_agendamento);

                        var turno = '';
                        if (horario < 12) {
                            turno = 'Manhã';
                        } else if (horario >= 12 && horario < 18) {
                            turno = 'Tarde';
                        } else {
                            turno = 'Noite';
                        }

                        // Format the date for comparison
                        var formattedDataAgendamento = formatDateForDisplay(item.data_agendamento);

                        return (
                            (filtroDataAgendamento === 'Todos' || formattedDataAgendamento.includes(filtroDataAgendamento)) &&
                            (filtroTurnoAgendamento === 'Todos' || turno === filtroTurnoAgendamento) &&
                            (filtroLocalAgendamento === 'Todos' || item.local === filtroLocalAgendamento) &&
                            (filtroDisciplina === 'Todos' || item.atividade_curricular === filtroDisciplina) &&
                            (filtroStatus === 'Todos' || item.status_agendamento === filtroStatus)
                        );
                    });

                    // Populate grid with filtered data
                    populateGridAgenda(filteredData);
                }

                // Function to load data from the API and populate the gridAgenda
                function loadDataAndPopulateGrid() {
                    api.agenda.consultarFutureDates().then(function (data) {
                        originalData = data; // Store original data for filtering
                        // Initial populate grid with original data
                        populateGridAgenda(data);
                    }).catch(function (error) {
                        console.log('Error fetching data');
                    });
                }

                // Initial load of table data
                loadDataAndPopulateGrid();

                function getStatusClass(status) {
                    switch (status) {
                        case 'Agendado':
                            return 'ui-state-default';
                        case 'No local':
                            return 'agendamento-ui';
                        case 'Atendido':
                            return 'atendido-ui';
                        case 'Desmarcado pelo aluno':
                            return 'desmarcado-aluno-ui';
                        case 'Faltou':
                            return 'faltou-ui';
                        default:
                            return '';
                    }
                }

                // Event listener for clearFilters button
                $('#clearFilters').click(function () {
                    // Clear filter inputs
                    $('#filtroDataAgendamento').val('Todos');
                    $('#filtroTurnoAgendamento').val('Todos');
                    $('#filtroLocalAgendamento').val('Todos');
                    $('#filtroDisciplina').val('Todos');
                    $('#filtroStatus').val('Todos');

                    // Reset grid to original data
                    populateGridAgenda(originalData);
                });

                // Event listener for changes in filter inputs
                $('#filtroDataAgendamento, #filtroTurnoAgendamento, #filtroLocalAgendamento, #filtroDisciplina, #filtroStatus').change(function () {
                    // Apply filters and update the grid
                    applyFilters();
                });
            });
        </script>
  </body>
</html>
