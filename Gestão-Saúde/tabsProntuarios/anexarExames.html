<div id="anexoExames">

    <table id="Exames" class="ui-jqgrid ui-widget ui-widget-content ui-corner-all" style="margin-left: 50px; margin-top: 15px; width: 85%; height: auto;">
        <thead class="ui-jqgrid-titlebar ui-widget-header ui-corner-top ui-helper-clearfix" style="font-size: larger; height: 10px;">
        <th style="width: 5%;">Data</th>
        <th style="width: 80%;">Descrição</th>
        <th style="width: 15%;">Tipo</th>
        <th style="width: 10%;">Baixar</th>
        </thead>
    </table>

    
    <!-- seção para upload de exames -->
    <div id="uploadExames" style="margin-left: 50px; margin-top: 15px; width: 85%; height: auto;" class="ui-widget tab tab-0 tab-0 ui-tabs-panel ui-widget-content ui-corner-bottom">
    <hr class="ui-state-default"><br>
    <label name="anexarexames" id="anexarexames" style="width:350px; font-size: 16; font-weight: bold;">Anexar exames</label><br>
        <label for="myfile">Selecione o arquivo:</label>
        <input type="file" id="myfile" name="myfile"><br>
        <label for="data">Data:</label>
        <input class="ui-state-default ui-corner-all mousetrap " type="date" id="data" name="data"><br>
        <label for="descricao">Descrição:</label>
        <textarea class="ui-state-default ui-corner-all mousetrap " type="text" id="descricao" name="descricao"></textarea><br>
        <label for="tipo">Tipo:</label>
        <input class="ui-state-default ui-corner-all mousetrap " type="text" id="tipo" name="tipo"><br>
        <input type="submit" value="Enviar" onclick="upload()">
    </div>

    <script>
    const dataInput = document.getElementById('data');
    const dataAtual = new Date().toISOString().split('T')[0];
    dataInput.value = dataAtual;

    // Função para enviar exame
    function upload() {
        console.log('Enviando exame...');
        const data = document.getElementById('data').value.split('-').reverse().join('/');
        const dados = {
            CPF: getUrlVars()['cpf'],
            Descricao: document.getElementById('descricao').value,
            Tipo: document.getElementById('tipo').value,
            Data: data,
            Arquivo: document.getElementById('myfile').files[0]
            }; 
        console.log(dados);
        api.arquivos.criar(dados).then((result)=>{
        alert(result.message)
        console.log(result)
        }).catch((error)=>{
        console.error(error)
        })

    }
    function adicionarNovaLinhaArquivos(data) {
        console.log(data)
    // Seleciona o corpo da tabela usando o id historicoPaciente
    const tbody = document.getElementById("Exames")
    // Cria um novo elemento de linha (<tr>)
    const novaLinha = document.createElement('tr');
    novaLinha.style.alignItems = 'center';
    novaLinha.classList.add('ui-state-default')

    // Adiciona o conteúdo da nova linha criando células de dados (<td>) e inserindo os valores
    novaLinha.innerHTML = `
        <td role="gridcell" style="text-align:center;">${data.Data}</td>
        <td role="gridcell" style="text-align:center;">${data.Descricao}</td>
        <td role="gridcell" style="text-align:center;">${data.Tipo}</td>
        <td role="gridcell" style="text-align:center;"><input class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-primary" type="button" value="Baixar exame" style="margin: 2px 2px 2px 0px;" onclick="baixarExame(${data.id})"></td>
    `;
    // Adiciona a nova linha ao corpo da tabela
    tbody.appendChild(novaLinha);
    }
    function baixarExame(id){
    api.arquivos.baixar({id}).then((result)=>{
        console.log(result)
        const link = document.createElement('a');
        link.href = window.location.origin + '/api/arquivos/' + result.Link;
        //abre a visualização do arquivo em uma nova aba
        link.setAttribute('target', '_blank');
        document.body.appendChild(link);
        link.click();
    })
    }

    api.arquivos.consultar({CPF: getUrlVars()['cpf']}).then((arquivos)=>{
        console.log(arquivos)
        arquivos.forEach(arquivo => {
        adicionarNovaLinhaArquivos(arquivo)
        })
        
    })

    </script>
</div>