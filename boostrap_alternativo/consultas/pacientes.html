<html lang="pt-br">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Consultar paciente</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="../assets/img/apple-touch-icon.png" rel="icon">
  <link href="../assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="../assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="../assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="../assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="../assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="../assets/css/style.css" rel="stylesheet">

  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
              
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- DataTables JS -->
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>

  <!-- Template Main JS File -->
  <script src="../assets/js/main.js"></script>

  <style>
    .hidden {
    display: none;
  }
  </style>
</head>

<body>

  <!-- ======= Mobile nav toggle button ======= -->
  <i class="bi bi-list mobile-nav-toggle d-xl-none"></i>

  <!-- ======= Header ======= -->
  <header id="header">
    <div class="d-flex flex-column">

      <div class="profile">
        <img src="../assets/img/logo_mini.jpg" alt="" class="img-fluid rounded-circle">
        <h1 class="text-light"><span id="Nome_usuario"></span></h1>
        
        <script>
          var Nome_usuario = document.getElementById("Nome_usuario");
          var usuario = JSON.parse(localStorage.getItem("usuario"));
          Nome_usuario.innerHTML = usuario.Nome;
        </script>
      </div>
    </div>

    <nav id="navbar" class="nav-menu navbar">
      <ul>
        <li><a href="../innerPage.html#hero" class="nav-link active"><i class="bx bx-home"></i> <span>Home</span></a></li>
        <li><a href="../innerPage.html#Consultas" class="nav-link"><i class="bi bi-search"></i></i> <span>Consultas</span></a></li>
        <li><a href="../innerPage.html#Cadastros" class="nav-link"><i class="bx bx-file-blank"></i> <span>Cadastros</span></a></li>
        <li><a href="../innerPage.html#Processos" class="nav-link"><i class="bx bx-server"></i> <span>Processos</span></a></li>
        <li data-permission="Administrador"><a href="../innerPage.html#Relatorios" class="nav-link"><i class="bi bi-file-earmark-bar-graph"></i></i><span>Relatórios</span></a></li>
        <li><a href="#../innerPage.htmltutoriais" class="nav-link"><i class="bi bi-youtube"></i></i><span>Tutoriais</span></a></li>
        <li><a href="#../innerPage.htmlcontact" class="nav-link"><i class="bx bx-envelope"></i> <span>Sugestões/Reportar erros</span></a></li>
        <br>
      </ul>
    </nav><!-- .nav-menu -->
    
    <button type="button" style="display: block; margin: 0 auto; width: 30%; color: maroon; border-radius: 2px; padding: auto;" onclick="window.location.href='index.html'">Logout</button>
    </div>
  </header><!-- End Header -->

<main id="main">

  <!-- ======= Breadcrumbs ======= -->
  <section class="breadcrumbs">
    <div class="container">

      <div class="d-flex justify-content-between align-items-center">
          <h2 style="margin-left: 100px;">Bem vindo, <span id="nomeOla" style="color: maroon; font-weight: bold;"></span>!</h2>
          <ol>
            <li><spam style="color: maroon;">Consultar paciente</spam></li>
            <li><span id="tipo_usuarioHome"></span></li>
          </ol>
                      
          <script>
              var tipo_usuarioHome = document.getElementById("tipo_usuarioHome");
              var nomeOla = document.getElementById("nomeOla");
              var usuario = JSON.parse(localStorage.getItem("usuario"));

              tipo_usuarioHome.innerHTML = usuario.Tipo;
              nomeOla.innerHTML = usuario.Nome;
          </script>

      </div>

    </div>
  </section><!-- End Breadcrumbs -->

  <main id="main">
    
    <!-- ======= Consultas Section ======= -->
    <section id="Consultas" class="O2Pages">
      <div class="container" style="margin-left: -5px; margin-top: -50px;">
        
        <div class="section-title">
          <h2>Consultar paciente</h2>

          <label id="lblNome" style="width: 60px;" class="inputLabelO2">Nome</label>
          <input type="text" id="txtNome" class="inputO2" value="" maxlength="255" style="width: 350px; margin-bottom: 20px;"/>
          <br>
          
          <label id="lblCpf" style="width: 60px;" class="inputLabelO2">CPF</label>
          <input type="text" id="txtCpf" class="inputO2" id="txtCpf" onkeyup="maskCpf()" maxlength="14" style="width: 150px;">
          
          <script>
            function maskCpf() {
                var cpf = document.getElementById("txtCpf");
                var newCpf = cpf.value.replace(/\D/g, '');
        
                if (newCpf.length > 3) {
                    newCpf = newCpf.substring(0, 3) + '.' + newCpf.substring(3);
                }
                if (newCpf.length > 7) {
                    newCpf = newCpf.substring(0, 7) + '.' + newCpf.substring(7);
                }
                if (newCpf.length > 11) {
                    newCpf = newCpf.substring(0, 11) + '-' + newCpf.substring(11);
                }
                cpf.value = newCpf;
            }
          </script>

          <button type="button" id="pesquisar" class="buttonO2"  style="margin-left: 15px;" onclick="buscar()">Pesquisar</button>

          <div class="breakLine"></div>

          <div class="container" style="margin-left: -5px;">
            <h3>Lista de pacientes</h3>
            <table id="tabelaPacientes" class="display">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>CPF</th>
                  <th>Telefone</th>
                  <th>Telefone 2</th>
                  <th>E-mail</th>
                </tr>
              </thead>
              <tbody>
                <!-- Adicione linhas conforme função -->
              </tbody>
            </table>
          </div>
          
          <script>
            $(document).ready(function () {
              $('#tabelaPacientes').DataTable({
                "stripeClasses": ['striped', ''],
                "language": {
                  "sEmptyTable": "Nenhum registro encontrado",
                  "sInfo": "Mostrando de _START_ até _END_ de _TOTAL_ registros",
                  "sInfoEmpty": "Mostrando 0 até 0 de 0 registros",
                  "sInfoFiltered": "(Filtrados de _MAX_ registros)",
                  "sInfoPostFix": "",
                  "sInfoThousands": ".",
                  "sLengthMenu": "_MENU_ resultados por página",
                  "sLoadingRecords": "Carregando...",
                  "sProcessing": "Processando...",
                  "sZeroRecords": "Nenhum registro encontrado",
                  "sSearch": "Pesquisar",
                  "oPaginate": {
                    "sNext": "Próximo",
                    "sPrevious": "Anterior",
                    "sFirst": "Primeiro",
                    "sLast": "Último"
                  },
                  "oAria": {
                    "sSortAscending": ": Ordenar colunas de forma ascendente",
                    "sSortDescending": ": Ordenar colunas de forma descendente"
                  },
                  "select": {
                    "rows": {
                      "_": "Selecionado %d linhas",
                      "0": "Nenhuma linha selecionada",
                      "1": "Selecionado 1 linha"
                    }
                  },
                  "buttons": {
                    "copy": "Copiar para a área de transferência",
                    "copyTitle": "Cópia bem sucedida",
                    "copySuccess": {
                      "1": "Uma linha copiada com sucesso",
                      "_": "%d linhas copiadas com sucesso"
                    }
                  }
                }
              });
            });
          </script>

          <script src="/API/API.js"></script>

          <script>
            function limparTabela() {
              const table = $('#tabelaPacientes').DataTable();
              table.clear().draw(); // Clear DataTables table
            }

            function adicionarNovaLinha(nome, cpf, Tel, Tel2, Email) {
              const table = $('#tabelaPacientes').DataTable();
              table.row.add([
                `<a href="prontuario.html?cpf=${cpf}">${nome}</a>`,
                `<a href="prontuario.html?cpf=${cpf}">${cpf}</a>`,
                `<a href="prontuario.html?cpf=${cpf}">${Tel}</a>`,
                `<a href="prontuario.html?cpf=${cpf}">${Tel2}</a>`,
                `<a href="prontuario.html?cpf=${cpf}">${Email}</a>`
              ]).draw(false); // Add a new row to DataTables and redraw
            }

            // Função de busca que determina qual função de consulta chamar com base nos campos de nome e CPF
            function buscar() {
              const nome = document.getElementById('txtNome').value;
              const cpf = document.getElementById('txtCpf').value;

              if (nome.trim() !== '') {
                consultarPacientesPorNome(nome);
              } else if (cpf.trim() !== '') {
                consultarPacientesPorCPF(cpf);
              } else {
                alert("Preencha o campo nome ou CPF para realizar a busca.");
              }
            }

            // Função para consultar pacientes por nome usando a API
            function consultarPacientesPorNome(nome) {
              api.pacientes.consultar({ Nome: nome })
                .then((pacientes) => {
                  limparTabela(); // Clear DataTables table

                  if (pacientes.length === 0) {
                    alert("Nenhum paciente encontrado");
                  } else {
                    pacientes.forEach(paciente => {
                      adicionarNovaLinha(
                        paciente.Nome,
                        paciente.CPF,
                        paciente.Tel,
                        paciente.Tel2,
                        paciente.Email
                      );
                    });
                  }
                })
                .catch((error) => {
                  console.error('Erro ao consultar pacientes:', error);
                });
            }

            function consultarPacientesPorCPF(cpf) {
              api.pacientes.consultar({ CPF: cpf })
                .then((pacientes) => {
                  limparTabela(); // Clear DataTables table

                  if (pacientes.length === 0) {
                    alert("Nenhum paciente encontrado");
                  } else {
                    pacientes.forEach(paciente => {
                      adicionarNovaLinha(
                        paciente.Nome,
                        paciente.CPF,
                        paciente.Tel,
                        paciente.Tel2,
                        paciente.Email
                      );
                    });
                  }
                })
                .catch((error) => {
                  console.error('Erro ao consultar pacientes:', error);
                });
            }
            
            // Adicionar eventos de busca nos campos de entrada
            document.getElementById('txtCpf').onkeydown = function (e) {
              if (e.key === 'Enter') {
                consultarPacientesPorCPF(document.getElementById('txtCpf').value);
              }
            }

            document.getElementById('txtNome').onkeydown = function (e) {
              if (e.key === 'Enter') {
                consultarPacientesPorNome(document.getElementById('txtNome').value);
              }
            }
          </script>
        </div>
      </div>
  </section><!-- End Consultas Section -->








  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer">
    <div class="container">
      <div class="copyright">
        &copy; Copyright <strong><span>FO-UFPel</span></strong>
      </div>
      </div>
  </footer><!-- End  Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="../assets/vendor/purecounter/purecounter_vanilla.js"></script>
  <script src="../assets/vendor/aos/aos.js"></script>
  <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="../assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="../assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="../assets/vendor/typed.js/typed.umd.js"></script>
  <script src="../assets/vendor/waypoints/noframework.waypoints.js"></script>
  <script src="../assets/vendor/php-email-form/validate.js"></script>

  <!-- Template Main JS File -->
  <script src="../assets/js/main.js"></script>

</body>


<script>
  //Filtra conteúdo por permissão do usuário
  function filterElementsByPermission() {
    const usuario = JSON.parse(localStorage.getItem('usuario'));
    const tipo = usuario ? usuario.Tipo : ''; // Get the user's permission type

    const elements = document.querySelectorAll('[data-permission]');
    elements.forEach(element => {
      const permission = element.getAttribute('data-permission');
      if (permission === tipo) {
        element.style.display = 'block'; // Display elements matching the user's permission
      } else {
        element.style.display = 'none'; // Hide elements not matching the user's permission
      }
    });
  }

  // Call the function to filter elements on page load
  filterElementsByPermission();
</script>
</html>